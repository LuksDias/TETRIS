<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tetris Pro - Versão Estável</title>
<style>
body{
    margin:0;
    background:linear-gradient(135deg,#141e30,#243b55);
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    font-family:Arial;
    color:white;
}
.container{display:flex;gap:20px;}
canvas{background:#111;box-shadow:0 0 20px black;}
.panel{width:200px;}
button{
    width:100%;
    padding:10px;
    background:#00d4ff;
    border:none;
    cursor:pointer;
    font-weight:bold;
}
button:hover{background:#00a0cc;}
#scores{font-size:14px;margin-top:10px;}
</style>
</head>
<body>

<div class="container">
<canvas id="game" width="240" height="400"></canvas>

<div class="panel">
<h2>Score</h2>
<div id="score">0</div>

<h2>Próxima</h2>
<canvas id="next" width="120" height="120"></canvas>

<button onclick="restart()">Reiniciar</button>

<h2>Ranking</h2>
<div id="scores"></div>
</div>
</div>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
ctx.scale(20,20);

const nextCanvas=document.getElementById("next");
const nextCtx=nextCanvas.getContext("2d");
nextCtx.scale(20,20);

const arena=createMatrix(12,20);

const player={
    pos:{x:0,y:0},
    matrix:null,
    next:null
};

let dropCounter=0;
let dropInterval=1000;
let lastTime=0;
let score=0;

const colors=[null,"#ff595e","#1982c4","#8ac926","#ffca3a","#6a4c93","#ff924c","#00f5d4"];

function createMatrix(w,h){
    const m=[];
    while(h--) m.push(new Array(w).fill(0));
    return m;
}

function createPiece(type){
    const pieces={
        T:[[0,0,0],[1,1,1],[0,1,0]],
        O:[[2,2],[2,2]],
        L:[[0,3,0],[0,3,0],[0,3,3]],
        J:[[0,4,0],[0,4,0],[4,4,0]],
        I:[[5,5,5,5]],
        S:[[0,6,6],[6,6,0],[0,0,0]],
        Z:[[7,7,0],[0,7,7],[0,0,0]]
    };
    return pieces[type];
}

function drawMatrix(matrix,offset,context=ctx){
    matrix.forEach((row,y)=>{
        row.forEach((value,x)=>{
            if(value!==0){
                context.fillStyle=colors[value];
                context.fillRect(x+offset.x,y+offset.y,1,1);
            }
        });
    });
}

function merge(arena,player){
    player.matrix.forEach((row,y)=>{
        row.forEach((value,x)=>{
            if(value!==0){
                arena[y+player.pos.y][x+player.pos.x]=value;
            }
        });
    });
}

function collide(arena,player){
    const m=player.matrix;
    const o=player.pos;
    for(let y=0;y<m.length;y++){
        for(let x=0;x<m[y].length;x++){
            if(m[y][x]!==0 &&
              (arena[y+o.y] &&
               arena[y+o.y][x+o.x])!==0){
                return true;
            }
        }
    }
    return false;
}

function arenaSweep(){
    for(let y=arena.length-1;y>=0;y--){
        if(arena[y].every(cell=>cell!==0)){
            arena.splice(y,1);
            arena.unshift(new Array(arena[0].length).fill(0));
            score+=100;
            dropInterval=Math.max(100,dropInterval-30);
            y++;
        }
    }
}

function playerDrop(){
    player.pos.y++;
    if(collide(arena,player)){
        player.pos.y--;
        merge(arena,player);
        arenaSweep();
        playerReset();
        updateScore();
    }
    dropCounter=0;
}

function playerHardDrop(){
    while(!collide(arena,player)){
        player.pos.y++;
    }
    player.pos.y--;
    merge(arena,player);
    arenaSweep();
    playerReset();
    updateScore();
    dropCounter=0;
}

function playerMove(dir){
    player.pos.x+=dir;
    if(collide(arena,player)){
        player.pos.x-=dir;
    }
}

function rotate(matrix){
    for(let y=0;y<matrix.length;y++){
        for(let x=0;x<y;x++){
            [matrix[x][y],matrix[y][x]]=[matrix[y][x],matrix[x][y]];
        }
    }
    matrix.forEach(row=>row.reverse());
}

function playerRotate(){
    const pos=player.pos.x;
    let offset=1;
    rotate(player.matrix);
    while(collide(arena,player)){
        player.pos.x+=offset;
        offset=-(offset+(offset>0?1:-1));
        if(offset>player.matrix[0].length){
            rotate(player.matrix);
            rotate(player.matrix);
            rotate(player.matrix);
            player.pos.x=pos;
            return;
        }
    }
}

function playerReset(){
    const pieces="ILJOTSZ";
    player.matrix=player.next||createPiece(pieces[Math.random()*pieces.length|0]);
    player.next=createPiece(pieces[Math.random()*pieces.length|0]);
    player.pos.y=0;
    player.pos.x=(arena[0].length/2|0)-(player.matrix[0].length/2|0);
    if(collide(arena,player)){
        gameOver();
    }
    drawNext();
}

function draw(){
    ctx.fillStyle="#111";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    drawMatrix(arena,{x:0,y:0});
    drawMatrix(player.matrix,player.pos);
}

function drawNext(){
    nextCtx.fillStyle="#111";
    nextCtx.fillRect(0,0,nextCanvas.width,nextCanvas.height);
    drawMatrix(player.next,{x:1,y:1},nextCtx);
}

function update(time=0){
    const delta=time-lastTime;
    lastTime=time;
    dropCounter+=delta;
    if(dropCounter>dropInterval) playerDrop();
    draw();
    requestAnimationFrame(update);
}

function updateScore(){
    document.getElementById("score").innerText=score;
}

function restart(){
    arena.forEach(row=>row.fill(0));
    score=0;
    dropInterval=1000;
    updateScore();
    playerReset();
}

function gameOver(){
    const name=prompt("Game Over! Digite seu nome:");
    if(name) saveScore(name,score);
    restart();
}

function saveScore(name,score){
    let scores=JSON.parse(localStorage.getItem("tetrisRanking"))||[];
    scores.push({name,score});
    scores.sort((a,b)=>b.score-a.score);
    scores=scores.slice(0,5);
    localStorage.setItem("tetrisRanking",JSON.stringify(scores));
    loadScores();
}

function loadScores(){
    let scores=JSON.parse(localStorage.getItem("tetrisRanking"))||[];
    document.getElementById("scores").innerHTML=
        scores.map(s=>`${s.name} - ${s.score}`).join("<br>");
}

document.addEventListener("keydown",event=>{
    if(event.code==="ArrowLeft") playerMove(-1);
    else if(event.code==="ArrowRight") playerMove(1);
    else if(event.code==="ArrowDown") playerDrop();
    else if(event.code==="ArrowUp") playerRotate();
    else if(event.code==="Space") playerHardDrop();
});

loadScores();
playerReset();
update();
</script>
</body>
</html>
